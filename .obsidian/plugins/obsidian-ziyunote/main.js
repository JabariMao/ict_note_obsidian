var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})},__copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod)),__toCommonJS=mod=>__copyProps(__defProp({},"__esModule",{value:!0}),mod);var main_exports={};__export(main_exports,{default:()=>ZiyuNotePlugin});module.exports=__toCommonJS(main_exports);var import_obsidian3=require("obsidian");var DEFAULT_SETTINGS={mySetting:""};var ziyunoteIcon=`<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor" d="M16.5,34.5s26.6-18,51.3,0L87,45"/>
<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"   d="M16.52,34.72s26.8,17.71,51.3-.56L87,24"/>
<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"  d="M52,66s18.52-11,36.76,0"/>
<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"  d="M15,66s18.52-11,36.76,0"/>
<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"  d="M52,77s18.52-11,36.76,0"/>
<path stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"  d="M15,77s18.52-11,36.76,0"/>
<rect stroke-miterlimit="10" stroke-linecap="round" stroke-width="10px" fill="none" stroke="currentColor"  x="1" y="1" width="99" height="98" rx="20"/>
`;var PACKET_TYPES=Object.create(null);PACKET_TYPES.open="0";PACKET_TYPES.close="1";PACKET_TYPES.ping="2";PACKET_TYPES.pong="3";PACKET_TYPES.message="4";PACKET_TYPES.upgrade="5";PACKET_TYPES.noop="6";var PACKET_TYPES_REVERSE=Object.create(null);Object.keys(PACKET_TYPES).forEach(key=>{PACKET_TYPES_REVERSE[PACKET_TYPES[key]]=key});var ERROR_PACKET={type:"error",data:"parser error"};var withNativeBlob=typeof Blob=="function"||typeof Blob!="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",withNativeArrayBuffer=typeof ArrayBuffer=="function",isView=obj=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(obj):obj&&obj.buffer instanceof ArrayBuffer,encodePacket=({type,data},supportsBinary,callback)=>withNativeBlob&&data instanceof Blob?supportsBinary?callback(data):encodeBlobAsBase64(data,callback):withNativeArrayBuffer&&(data instanceof ArrayBuffer||isView(data))?supportsBinary?callback(data):encodeBlobAsBase64(new Blob([data]),callback):callback(PACKET_TYPES[type]+(data||"")),encodeBlobAsBase64=(data,callback)=>{let fileReader=new FileReader;return fileReader.onload=function(){let content=fileReader.result.split(",")[1];callback("b"+(content||""))},fileReader.readAsDataURL(data)};function toArray(data){return data instanceof Uint8Array?data:data instanceof ArrayBuffer?new Uint8Array(data):new Uint8Array(data.buffer,data.byteOffset,data.byteLength)}var TEXT_ENCODER;function encodePacketToBinary(packet,callback){if(withNativeBlob&&packet.data instanceof Blob)return packet.data.arrayBuffer().then(toArray).then(callback);if(withNativeArrayBuffer&&(packet.data instanceof ArrayBuffer||isView(packet.data)))return callback(toArray(packet.data));encodePacket(packet,!1,encoded=>{TEXT_ENCODER||(TEXT_ENCODER=new TextEncoder),callback(TEXT_ENCODER.encode(encoded))})}var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=typeof Uint8Array=="undefined"?[]:new Uint8Array(256);for(let i2=0;i2<chars.length;i2++)lookup[chars.charCodeAt(i2)]=i2;var decode=base64=>{let bufferLength=base64.length*.75,len=base64.length,i2,p=0,encoded1,encoded2,encoded3,encoded4;base64[base64.length-1]==="="&&(bufferLength--,base64[base64.length-2]==="="&&bufferLength--);let arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i2=0;i2<len;i2+=4)encoded1=lookup[base64.charCodeAt(i2)],encoded2=lookup[base64.charCodeAt(i2+1)],encoded3=lookup[base64.charCodeAt(i2+2)],encoded4=lookup[base64.charCodeAt(i2+3)],bytes[p++]=encoded1<<2|encoded2>>4,bytes[p++]=(encoded2&15)<<4|encoded3>>2,bytes[p++]=(encoded3&3)<<6|encoded4&63;return arraybuffer};var withNativeArrayBuffer2=typeof ArrayBuffer=="function",decodePacket=(encodedPacket,binaryType)=>{if(typeof encodedPacket!="string")return{type:"message",data:mapBinary(encodedPacket,binaryType)};let type=encodedPacket.charAt(0);return type==="b"?{type:"message",data:decodeBase64Packet(encodedPacket.substring(1),binaryType)}:PACKET_TYPES_REVERSE[type]?encodedPacket.length>1?{type:PACKET_TYPES_REVERSE[type],data:encodedPacket.substring(1)}:{type:PACKET_TYPES_REVERSE[type]}:ERROR_PACKET},decodeBase64Packet=(data,binaryType)=>{if(withNativeArrayBuffer2){let decoded=decode(data);return mapBinary(decoded,binaryType)}else return{base64:!0,data}},mapBinary=(data,binaryType)=>{switch(binaryType){case"blob":return data instanceof Blob?data:new Blob([data]);case"arraybuffer":default:return data instanceof ArrayBuffer?data:data.buffer}};var SEPARATOR=String.fromCharCode(30),encodePayload=(packets,callback)=>{let length2=packets.length,encodedPackets=new Array(length2),count=0;packets.forEach((packet,i2)=>{encodePacket(packet,!1,encodedPacket=>{encodedPackets[i2]=encodedPacket,++count===length2&&callback(encodedPackets.join(SEPARATOR))})})},decodePayload=(encodedPayload,binaryType)=>{let encodedPackets=encodedPayload.split(SEPARATOR),packets=[];for(let i2=0;i2<encodedPackets.length;i2++){let decodedPacket=decodePacket(encodedPackets[i2],binaryType);if(packets.push(decodedPacket),decodedPacket.type==="error")break}return packets},TEXT_DECODER;function decodePacketFromBinary(data,isBinary2,binaryType){TEXT_DECODER||(TEXT_DECODER=new TextDecoder);let isPlainBinary=isBinary2||data[0]<48||data[0]>54;return decodePacket(isPlainBinary?data:TEXT_DECODER.decode(data),binaryType)}var protocol=4;function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype)obj[key]=Emitter.prototype[key];return obj}Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){return this._callbacks=this._callbacks||{},(this._callbacks["$"+event]=this._callbacks["$"+event]||[]).push(fn),this};Emitter.prototype.once=function(event,fn){function on2(){this.off(event,on2),fn.apply(this,arguments)}return on2.fn=fn,this.on(event,on2),this};Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var callbacks=this._callbacks["$"+event];if(!callbacks)return this;if(arguments.length==1)return delete this._callbacks["$"+event],this;for(var cb,i2=0;i2<callbacks.length;i2++)if(cb=callbacks[i2],cb===fn||cb.fn===fn){callbacks.splice(i2,1);break}return callbacks.length===0&&delete this._callbacks["$"+event],this};Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};for(var args=new Array(arguments.length-1),callbacks=this._callbacks["$"+event],i2=1;i2<arguments.length;i2++)args[i2-1]=arguments[i2];if(callbacks){callbacks=callbacks.slice(0);for(var i2=0,len=callbacks.length;i2<len;++i2)callbacks[i2].apply(this,args)}return this};Emitter.prototype.emitReserved=Emitter.prototype.emit;Emitter.prototype.listeners=function(event){return this._callbacks=this._callbacks||{},this._callbacks["$"+event]||[]};Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length};var globalThisShim=(()=>typeof self!="undefined"?self:typeof window!="undefined"?window:Function("return this")())();function pick(obj,...attr){return attr.reduce((acc,k)=>(obj.hasOwnProperty(k)&&(acc[k]=obj[k]),acc),{})}var NATIVE_SET_TIMEOUT=globalThisShim.setTimeout,NATIVE_CLEAR_TIMEOUT=globalThisShim.clearTimeout;function installTimerFunctions(obj,opts){opts.useNativeTimers?(obj.setTimeoutFn=NATIVE_SET_TIMEOUT.bind(globalThisShim),obj.clearTimeoutFn=NATIVE_CLEAR_TIMEOUT.bind(globalThisShim)):(obj.setTimeoutFn=globalThisShim.setTimeout.bind(globalThisShim),obj.clearTimeoutFn=globalThisShim.clearTimeout.bind(globalThisShim))}var BASE64_OVERHEAD=1.33;function byteLength(obj){return typeof obj=="string"?utf8Length(obj):Math.ceil((obj.byteLength||obj.size)*BASE64_OVERHEAD)}function utf8Length(str){let c=0,length2=0;for(let i2=0,l=str.length;i2<l;i2++)c=str.charCodeAt(i2),c<128?length2+=1:c<2048?length2+=2:c<55296||c>=57344?length2+=3:(i2++,length2+=4);return length2}function encode(obj){let str="";for(let i2 in obj)obj.hasOwnProperty(i2)&&(str.length&&(str+="&"),str+=encodeURIComponent(i2)+"="+encodeURIComponent(obj[i2]));return str}function decode2(qs){let qry={},pairs=qs.split("&");for(let i2=0,l=pairs.length;i2<l;i2++){let pair=pairs[i2].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}var TransportError=class extends Error{constructor(reason,description,context){super(reason),this.description=description,this.context=context,this.type="TransportError"}},Transport=class extends Emitter{constructor(opts){super(),this.writable=!1,installTimerFunctions(this,opts),this.opts=opts,this.query=opts.query,this.socket=opts.socket}onError(reason,description,context){return super.emitReserved("error",new TransportError(reason,description,context)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(packets){this.readyState==="open"&&this.write(packets)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(data){let packet=decodePacket(data,this.socket.binaryType);this.onPacket(packet)}onPacket(packet){super.emitReserved("packet",packet)}onClose(details){this.readyState="closed",super.emitReserved("close",details)}pause(onPause){}createUri(schema,query={}){return schema+"://"+this._hostname()+this._port()+this.opts.path+this._query(query)}_hostname(){let hostname=this.opts.hostname;return hostname.indexOf(":")===-1?hostname:"["+hostname+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(query){let encodedQuery=encode(query);return encodedQuery.length?"?"+encodedQuery:""}};var alphabet="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),length=64,map={},seed=0,i=0,prev;function encode2(num){let encoded="";do encoded=alphabet[num%length]+encoded,num=Math.floor(num/length);while(num>0);return encoded}function yeast(){let now=encode2(+new Date);return now!==prev?(seed=0,prev=now):now+"."+encode2(seed++)}for(;i<length;i++)map[alphabet[i]]=i;var value=!1;try{value=typeof XMLHttpRequest!="undefined"&&"withCredentials"in new XMLHttpRequest}catch(err){}var hasCORS=value;function XHR(opts){let xdomain=opts.xdomain;try{if(typeof XMLHttpRequest!="undefined"&&(!xdomain||hasCORS))return new XMLHttpRequest}catch(e){}if(!xdomain)try{return new globalThisShim[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(e){}}function empty(){}var hasXHR2=function(){return new XHR({xdomain:!1}).responseType!=null}(),Polling=class extends Transport{constructor(opts){if(super(opts),this.polling=!1,typeof location!="undefined"){let isSSL=location.protocol==="https:",port=location.port;port||(port=isSSL?"443":"80"),this.xd=typeof location!="undefined"&&opts.hostname!==location.hostname||port!==opts.port}let forceBase64=opts&&opts.forceBase64;this.supportsBinary=hasXHR2&&!forceBase64,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(onPause){this.readyState="pausing";let pause=()=>{this.readyState="paused",onPause()};if(this.polling||!this.writable){let total=0;this.polling&&(total++,this.once("pollComplete",function(){--total||pause()})),this.writable||(total++,this.once("drain",function(){--total||pause()}))}else pause()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(data){let callback=packet=>{if(this.readyState==="opening"&&packet.type==="open"&&this.onOpen(),packet.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(packet)};decodePayload(data,this.socket.binaryType).forEach(callback),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){let close=()=>{this.write([{type:"close"}])};this.readyState==="open"?close():this.once("open",close)}write(packets){this.writable=!1,encodePayload(packets,data=>{this.doWrite(data,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let schema=this.opts.secure?"https":"http",query=this.query||{};return this.opts.timestampRequests!==!1&&(query[this.opts.timestampParam]=yeast()),!this.supportsBinary&&!query.sid&&(query.b64=1),this.createUri(schema,query)}request(opts={}){return Object.assign(opts,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new Request(this.uri(),opts)}doWrite(data,fn){let req=this.request({method:"POST",data});req.on("success",fn),req.on("error",(xhrStatus,context)=>{this.onError("xhr post error",xhrStatus,context)})}doPoll(){let req=this.request();req.on("data",this.onData.bind(this)),req.on("error",(xhrStatus,context)=>{this.onError("xhr poll error",xhrStatus,context)}),this.pollXhr=req}},Request=class extends Emitter{constructor(uri,opts){super(),installTimerFunctions(this,opts),this.opts=opts,this.method=opts.method||"GET",this.uri=uri,this.data=opts.data!==void 0?opts.data:null,this.create()}create(){var _a;let opts=pick(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");opts.xdomain=!!this.opts.xd;let xhr=this.xhr=new XHR(opts);try{xhr.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){xhr.setDisableHeaderCheck&&xhr.setDisableHeaderCheck(!0);for(let i2 in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(i2)&&xhr.setRequestHeader(i2,this.opts.extraHeaders[i2])}}catch(e){}if(this.method==="POST")try{xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{xhr.setRequestHeader("Accept","*/*")}catch(e){}(_a=this.opts.cookieJar)===null||_a===void 0||_a.addCookies(xhr),"withCredentials"in xhr&&(xhr.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(xhr.timeout=this.opts.requestTimeout),xhr.onreadystatechange=()=>{var _a2;xhr.readyState===3&&((_a2=this.opts.cookieJar)===null||_a2===void 0||_a2.parseCookies(xhr)),xhr.readyState===4&&(xhr.status===200||xhr.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof xhr.status=="number"?xhr.status:0)},0))},xhr.send(this.data)}catch(e){this.setTimeoutFn(()=>{this.onError(e)},0);return}typeof document!="undefined"&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)}onError(err){this.emitReserved("error",err,this.xhr),this.cleanup(!0)}cleanup(fromError){if(!(typeof this.xhr=="undefined"||this.xhr===null)){if(this.xhr.onreadystatechange=empty,fromError)try{this.xhr.abort()}catch(e){}typeof document!="undefined"&&delete Request.requests[this.index],this.xhr=null}}onLoad(){let data=this.xhr.responseText;data!==null&&(this.emitReserved("data",data),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}};Request.requestsCount=0;Request.requests={};if(typeof document!="undefined"){if(typeof attachEvent=="function")attachEvent("onunload",unloadHandler);else if(typeof addEventListener=="function"){let terminationEvent="onpagehide"in globalThisShim?"pagehide":"unload";addEventListener(terminationEvent,unloadHandler,!1)}}function unloadHandler(){for(let i2 in Request.requests)Request.requests.hasOwnProperty(i2)&&Request.requests[i2].abort()}var nextTick=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?cb=>Promise.resolve().then(cb):(cb,setTimeoutFn)=>setTimeoutFn(cb,0))(),WebSocket=globalThisShim.WebSocket||globalThisShim.MozWebSocket,usingBrowserWebSocket=!0,defaultBinaryType="arraybuffer";var isReactNative=typeof navigator!="undefined"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative",WS=class extends Transport{constructor(opts){super(opts),this.supportsBinary=!opts.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;let uri=this.uri(),protocols=this.opts.protocols,opts=isReactNative?{}:pick(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(opts.headers=this.opts.extraHeaders);try{this.ws=usingBrowserWebSocket&&!isReactNative?protocols?new WebSocket(uri,protocols):new WebSocket(uri):new WebSocket(uri,protocols,opts)}catch(err){return this.emitReserved("error",err)}this.ws.binaryType=this.socket.binaryType||defaultBinaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=closeEvent=>this.onClose({description:"websocket connection closed",context:closeEvent}),this.ws.onmessage=ev=>this.onData(ev.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(packets){this.writable=!1;for(let i2=0;i2<packets.length;i2++){let packet=packets[i2],lastPacket=i2===packets.length-1;encodePacket(packet,this.supportsBinary,data=>{let opts={};usingBrowserWebSocket||(packet.options&&(opts.compress=packet.options.compress),this.opts.perMessageDeflate&&(typeof data=="string"?Buffer.byteLength(data):data.length)<this.opts.perMessageDeflate.threshold&&(opts.compress=!1));try{usingBrowserWebSocket?this.ws.send(data):this.ws.send(data,opts)}catch(e){}lastPacket&&nextTick(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws!="undefined"&&(this.ws.close(),this.ws=null)}uri(){let schema=this.opts.secure?"wss":"ws",query=this.query||{};return this.opts.timestampRequests&&(query[this.opts.timestampParam]=yeast()),this.supportsBinary||(query.b64=1),this.createUri(schema,query)}check(){return!!WebSocket}};function shouldIncludeBinaryHeader(packet,encoded){return packet.type==="message"&&typeof packet.data!="string"&&encoded[0]>=48&&encoded[0]<=54}var WT=class extends Transport{get name(){return"webtransport"}doOpen(){typeof WebTransport=="function"&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then(()=>{this.onClose()}).catch(err=>{this.onError("webtransport error",err)}),this.transport.ready.then(()=>{this.transport.createBidirectionalStream().then(stream=>{let reader=stream.readable.getReader();this.writer=stream.writable.getWriter();let binaryFlag,read=()=>{reader.read().then(({done,value:value2})=>{done||(!binaryFlag&&value2.byteLength===1&&value2[0]===54?binaryFlag=!0:(this.onPacket(decodePacketFromBinary(value2,binaryFlag,"arraybuffer")),binaryFlag=!1),read())}).catch(err=>{})};read();let handshake=this.query.sid?`0{"sid":"${this.query.sid}"}`:"0";this.writer.write(new TextEncoder().encode(handshake)).then(()=>this.onOpen())})}))}write(packets){this.writable=!1;for(let i2=0;i2<packets.length;i2++){let packet=packets[i2],lastPacket=i2===packets.length-1;encodePacketToBinary(packet,data=>{shouldIncludeBinaryHeader(packet,data)&&this.writer.write(Uint8Array.of(54)),this.writer.write(data).then(()=>{lastPacket&&nextTick(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})})}}doClose(){var _a;(_a=this.transport)===null||_a===void 0||_a.close()}};var transports={websocket:WS,webtransport:WT,polling:Polling};var re=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function parse(str){let src=str,b=str.indexOf("["),e=str.indexOf("]");b!=-1&&e!=-1&&(str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length));let m=re.exec(str||""),uri={},i2=14;for(;i2--;)uri[parts[i2]]=m[i2]||"";return b!=-1&&e!=-1&&(uri.source=src,uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":"),uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":"),uri.ipv6uri=!0),uri.pathNames=pathNames(uri,uri.path),uri.queryKey=queryKey(uri,uri.query),uri}function pathNames(obj,path2){let regx=/\/{2,9}/g,names=path2.replace(regx,"/").split("/");return(path2.slice(0,1)=="/"||path2.length===0)&&names.splice(0,1),path2.slice(-1)=="/"&&names.splice(names.length-1,1),names}function queryKey(uri,query){let data={};return query.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function($0,$1,$2){$1&&(data[$1]=$2)}),data}var Socket=class extends Emitter{constructor(uri,opts={}){super(),this.writeBuffer=[],uri&&typeof uri=="object"&&(opts=uri,uri=null),uri?(uri=parse(uri),opts.hostname=uri.host,opts.secure=uri.protocol==="https"||uri.protocol==="wss",opts.port=uri.port,uri.query&&(opts.query=uri.query)):opts.host&&(opts.hostname=parse(opts.host).host),installTimerFunctions(this,opts),this.secure=opts.secure!=null?opts.secure:typeof location!="undefined"&&location.protocol==="https:",opts.hostname&&!opts.port&&(opts.port=this.secure?"443":"80"),this.hostname=opts.hostname||(typeof location!="undefined"?location.hostname:"localhost"),this.port=opts.port||(typeof location!="undefined"&&location.port?location.port:this.secure?"443":"80"),this.transports=opts.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},opts),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=decode2(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(name){let query=Object.assign({},this.opts.query);query.EIO=protocol,query.transport=name,this.id&&(query.sid=this.id);let opts=Object.assign({},this.opts,{query,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[name]);return new transports[name](opts)}open(){let transport;if(this.opts.rememberUpgrade&&Socket.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)transport="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else transport=this.transports[0];this.readyState="opening";try{transport=this.createTransport(transport)}catch(e){this.transports.shift(),this.open();return}transport.open(),this.setTransport(transport)}setTransport(transport){this.transport&&this.transport.removeAllListeners(),this.transport=transport,transport.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",reason=>this.onClose("transport close",reason))}probe(name){let transport=this.createTransport(name),failed=!1;Socket.priorWebsocketSuccess=!1;let onTransportOpen=()=>{failed||(transport.send([{type:"ping",data:"probe"}]),transport.once("packet",msg=>{if(!failed)if(msg.type==="pong"&&msg.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",transport),!transport)return;Socket.priorWebsocketSuccess=transport.name==="websocket",this.transport.pause(()=>{failed||this.readyState!=="closed"&&(cleanup(),this.setTransport(transport),transport.send([{type:"upgrade"}]),this.emitReserved("upgrade",transport),transport=null,this.upgrading=!1,this.flush())})}else{let err=new Error("probe error");err.transport=transport.name,this.emitReserved("upgradeError",err)}}))};function freezeTransport(){failed||(failed=!0,cleanup(),transport.close(),transport=null)}let onerror=err=>{let error=new Error("probe error: "+err);error.transport=transport.name,freezeTransport(),this.emitReserved("upgradeError",error)};function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){transport&&to.name!==transport.name&&freezeTransport()}let cleanup=()=>{transport.removeListener("open",onTransportOpen),transport.removeListener("error",onerror),transport.removeListener("close",onTransportClose),this.off("close",onclose),this.off("upgrading",onupgrade)};transport.once("open",onTransportOpen),transport.once("error",onerror),transport.once("close",onTransportClose),this.once("close",onclose),this.once("upgrading",onupgrade),this.upgrades.indexOf("webtransport")!==-1&&name!=="webtransport"?this.setTimeoutFn(()=>{failed||transport.open()},200):transport.open()}onOpen(){if(this.readyState="open",Socket.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let i2=0,l=this.upgrades.length;for(;i2<l;i2++)this.probe(this.upgrades[i2])}}onPacket(packet){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",packet),this.emitReserved("heartbeat"),packet.type){case"open":this.onHandshake(JSON.parse(packet.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":let err=new Error("server error");err.code=packet.data,this.onError(err);break;case"message":this.emitReserved("data",packet.data),this.emitReserved("message",packet.data);break}}onHandshake(data){this.emitReserved("handshake",data),this.id=data.sid,this.transport.query.sid=data.sid,this.upgrades=this.filterUpgrades(data.upgrades),this.pingInterval=data.pingInterval,this.pingTimeout=data.pingTimeout,this.maxPayload=data.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){let packets=this.getWritablePackets();this.transport.send(packets),this.prevBufferLen=packets.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let payloadSize=1;for(let i2=0;i2<this.writeBuffer.length;i2++){let data=this.writeBuffer[i2].data;if(data&&(payloadSize+=byteLength(data)),i2>0&&payloadSize>this.maxPayload)return this.writeBuffer.slice(0,i2);payloadSize+=2}return this.writeBuffer}write(msg,options,fn){return this.sendPacket("message",msg,options,fn),this}send(msg,options,fn){return this.sendPacket("message",msg,options,fn),this}sendPacket(type,data,options,fn){if(typeof data=="function"&&(fn=data,data=void 0),typeof options=="function"&&(fn=options,options=null),this.readyState==="closing"||this.readyState==="closed")return;options=options||{},options.compress=options.compress!==!1;let packet={type,data,options};this.emitReserved("packetCreate",packet),this.writeBuffer.push(packet),fn&&this.once("flush",fn),this.flush()}close(){let close=()=>{this.onClose("forced close"),this.transport.close()},cleanupAndClose=()=>{this.off("upgrade",cleanupAndClose),this.off("upgradeError",cleanupAndClose),close()},waitForUpgrade=()=>{this.once("upgrade",cleanupAndClose),this.once("upgradeError",cleanupAndClose)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?waitForUpgrade():close()}):this.upgrading?waitForUpgrade():close()),this}onError(err){Socket.priorWebsocketSuccess=!1,this.emitReserved("error",err),this.onClose("transport error",err)}onClose(reason,description){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",reason,description),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(upgrades){let filteredUpgrades=[],i2=0,j=upgrades.length;for(;i2<j;i2++)~this.transports.indexOf(upgrades[i2])&&filteredUpgrades.push(upgrades[i2]);return filteredUpgrades}};Socket.protocol=protocol;var protocol2=Socket.protocol;function url(uri,path2="",loc){let obj=uri;loc=loc||typeof location!="undefined"&&location,uri==null&&(uri=loc.protocol+"//"+loc.host),typeof uri=="string"&&(uri.charAt(0)==="/"&&(uri.charAt(1)==="/"?uri=loc.protocol+uri:uri=loc.host+uri),/^(https?|wss?):\/\//.test(uri)||(typeof loc!="undefined"?uri=loc.protocol+"//"+uri:uri="https://"+uri),obj=parse(uri)),obj.port||(/^(http|ws)$/.test(obj.protocol)?obj.port="80":/^(http|ws)s$/.test(obj.protocol)&&(obj.port="443")),obj.path=obj.path||"/";let host=obj.host.indexOf(":")!==-1?"["+obj.host+"]":obj.host;return obj.id=obj.protocol+"://"+host+":"+obj.port+path2,obj.href=obj.protocol+"://"+host+(loc&&loc.port===obj.port?"":":"+obj.port),obj}var esm_exports={};__export(esm_exports,{Decoder:()=>Decoder,Encoder:()=>Encoder,PacketType:()=>PacketType,protocol:()=>protocol3});var withNativeArrayBuffer3=typeof ArrayBuffer=="function",isView2=obj=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(obj):obj.buffer instanceof ArrayBuffer,toString=Object.prototype.toString,withNativeBlob2=typeof Blob=="function"||typeof Blob!="undefined"&&toString.call(Blob)==="[object BlobConstructor]",withNativeFile=typeof File=="function"||typeof File!="undefined"&&toString.call(File)==="[object FileConstructor]";function isBinary(obj){return withNativeArrayBuffer3&&(obj instanceof ArrayBuffer||isView2(obj))||withNativeBlob2&&obj instanceof Blob||withNativeFile&&obj instanceof File}function hasBinary(obj,toJSON){if(!obj||typeof obj!="object")return!1;if(Array.isArray(obj)){for(let i2=0,l=obj.length;i2<l;i2++)if(hasBinary(obj[i2]))return!0;return!1}if(isBinary(obj))return!0;if(obj.toJSON&&typeof obj.toJSON=="function"&&arguments.length===1)return hasBinary(obj.toJSON(),!0);for(let key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)&&hasBinary(obj[key]))return!0;return!1}function deconstructPacket(packet){let buffers=[],packetData=packet.data,pack=packet;return pack.data=_deconstructPacket(packetData,buffers),pack.attachments=buffers.length,{packet:pack,buffers}}function _deconstructPacket(data,buffers){if(!data)return data;if(isBinary(data)){let placeholder={_placeholder:!0,num:buffers.length};return buffers.push(data),placeholder}else if(Array.isArray(data)){let newData=new Array(data.length);for(let i2=0;i2<data.length;i2++)newData[i2]=_deconstructPacket(data[i2],buffers);return newData}else if(typeof data=="object"&&!(data instanceof Date)){let newData={};for(let key in data)Object.prototype.hasOwnProperty.call(data,key)&&(newData[key]=_deconstructPacket(data[key],buffers));return newData}return data}function reconstructPacket(packet,buffers){return packet.data=_reconstructPacket(packet.data,buffers),delete packet.attachments,packet}function _reconstructPacket(data,buffers){if(!data)return data;if(data&&data._placeholder===!0){if(typeof data.num=="number"&&data.num>=0&&data.num<buffers.length)return buffers[data.num];throw new Error("illegal attachments")}else if(Array.isArray(data))for(let i2=0;i2<data.length;i2++)data[i2]=_reconstructPacket(data[i2],buffers);else if(typeof data=="object")for(let key in data)Object.prototype.hasOwnProperty.call(data,key)&&(data[key]=_reconstructPacket(data[key],buffers));return data}var RESERVED_EVENTS=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],protocol3=5,PacketType;(function(PacketType2){PacketType2[PacketType2.CONNECT=0]="CONNECT",PacketType2[PacketType2.DISCONNECT=1]="DISCONNECT",PacketType2[PacketType2.EVENT=2]="EVENT",PacketType2[PacketType2.ACK=3]="ACK",PacketType2[PacketType2.CONNECT_ERROR=4]="CONNECT_ERROR",PacketType2[PacketType2.BINARY_EVENT=5]="BINARY_EVENT",PacketType2[PacketType2.BINARY_ACK=6]="BINARY_ACK"})(PacketType||(PacketType={}));var Encoder=class{constructor(replacer){this.replacer=replacer}encode(obj){return(obj.type===PacketType.EVENT||obj.type===PacketType.ACK)&&hasBinary(obj)?this.encodeAsBinary({type:obj.type===PacketType.EVENT?PacketType.BINARY_EVENT:PacketType.BINARY_ACK,nsp:obj.nsp,data:obj.data,id:obj.id}):[this.encodeAsString(obj)]}encodeAsString(obj){let str=""+obj.type;return(obj.type===PacketType.BINARY_EVENT||obj.type===PacketType.BINARY_ACK)&&(str+=obj.attachments+"-"),obj.nsp&&obj.nsp!=="/"&&(str+=obj.nsp+","),obj.id!=null&&(str+=obj.id),obj.data!=null&&(str+=JSON.stringify(obj.data,this.replacer)),str}encodeAsBinary(obj){let deconstruction=deconstructPacket(obj),pack=this.encodeAsString(deconstruction.packet),buffers=deconstruction.buffers;return buffers.unshift(pack),buffers}};function isObject(value2){return Object.prototype.toString.call(value2)==="[object Object]"}var Decoder=class extends Emitter{constructor(reviver){super(),this.reviver=reviver}add(obj){let packet;if(typeof obj=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");packet=this.decodeString(obj);let isBinaryEvent=packet.type===PacketType.BINARY_EVENT;isBinaryEvent||packet.type===PacketType.BINARY_ACK?(packet.type=isBinaryEvent?PacketType.EVENT:PacketType.ACK,this.reconstructor=new BinaryReconstructor(packet),packet.attachments===0&&super.emitReserved("decoded",packet)):super.emitReserved("decoded",packet)}else if(isBinary(obj)||obj.base64)if(this.reconstructor)packet=this.reconstructor.takeBinaryData(obj),packet&&(this.reconstructor=null,super.emitReserved("decoded",packet));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+obj)}decodeString(str){let i2=0,p={type:Number(str.charAt(0))};if(PacketType[p.type]===void 0)throw new Error("unknown packet type "+p.type);if(p.type===PacketType.BINARY_EVENT||p.type===PacketType.BINARY_ACK){let start=i2+1;for(;str.charAt(++i2)!=="-"&&i2!=str.length;);let buf=str.substring(start,i2);if(buf!=Number(buf)||str.charAt(i2)!=="-")throw new Error("Illegal attachments");p.attachments=Number(buf)}if(str.charAt(i2+1)==="/"){let start=i2+1;for(;++i2&&!(str.charAt(i2)===","||i2===str.length););p.nsp=str.substring(start,i2)}else p.nsp="/";let next=str.charAt(i2+1);if(next!==""&&Number(next)==next){let start=i2+1;for(;++i2;){let c=str.charAt(i2);if(c==null||Number(c)!=c){--i2;break}if(i2===str.length)break}p.id=Number(str.substring(start,i2+1))}if(str.charAt(++i2)){let payload=this.tryParse(str.substr(i2));if(Decoder.isPayloadValid(p.type,payload))p.data=payload;else throw new Error("invalid payload")}return p}tryParse(str){try{return JSON.parse(str,this.reviver)}catch(e){return!1}}static isPayloadValid(type,payload){switch(type){case PacketType.CONNECT:return isObject(payload);case PacketType.DISCONNECT:return payload===void 0;case PacketType.CONNECT_ERROR:return typeof payload=="string"||isObject(payload);case PacketType.EVENT:case PacketType.BINARY_EVENT:return Array.isArray(payload)&&(typeof payload[0]=="number"||typeof payload[0]=="string"&&RESERVED_EVENTS.indexOf(payload[0])===-1);case PacketType.ACK:case PacketType.BINARY_ACK:return Array.isArray(payload)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}},BinaryReconstructor=class{constructor(packet){this.packet=packet,this.buffers=[],this.reconPack=packet}takeBinaryData(binData){if(this.buffers.push(binData),this.buffers.length===this.reconPack.attachments){let packet=reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),packet}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}};function on(obj,ev,fn){return obj.on(ev,fn),function(){obj.off(ev,fn)}}var RESERVED_EVENTS2=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),Socket2=class extends Emitter{constructor(io,nsp,opts){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=io,this.nsp=nsp,opts&&opts.auth&&(this.auth=opts.auth),this._opts=Object.assign({},opts),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;let io=this.io;this.subs=[on(io,"open",this.onopen.bind(this)),on(io,"packet",this.onpacket.bind(this)),on(io,"error",this.onerror.bind(this)),on(io,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...args){return args.unshift("message"),this.emit.apply(this,args),this}emit(ev,...args){if(RESERVED_EVENTS2.hasOwnProperty(ev))throw new Error('"'+ev.toString()+'" is a reserved event name');if(args.unshift(ev),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(args),this;let packet={type:PacketType.EVENT,data:args};if(packet.options={},packet.options.compress=this.flags.compress!==!1,typeof args[args.length-1]=="function"){let id=this.ids++,ack=args.pop();this._registerAckCallback(id,ack),packet.id=id}let isTransportWritable=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!isTransportWritable||!this.connected)||(this.connected?(this.notifyOutgoingListeners(packet),this.packet(packet)):this.sendBuffer.push(packet)),this.flags={},this}_registerAckCallback(id,ack){var _a;let timeout=(_a=this.flags.timeout)!==null&&_a!==void 0?_a:this._opts.ackTimeout;if(timeout===void 0){this.acks[id]=ack;return}let timer=this.io.setTimeoutFn(()=>{delete this.acks[id];for(let i2=0;i2<this.sendBuffer.length;i2++)this.sendBuffer[i2].id===id&&this.sendBuffer.splice(i2,1);ack.call(this,new Error("operation has timed out"))},timeout);this.acks[id]=(...args)=>{this.io.clearTimeoutFn(timer),ack.apply(this,[null,...args])}}emitWithAck(ev,...args){let withErr=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((resolve,reject)=>{args.push((arg1,arg2)=>withErr?arg1?reject(arg1):resolve(arg2):resolve(arg1)),this.emit(ev,...args)})}_addToQueue(args){let ack;typeof args[args.length-1]=="function"&&(ack=args.pop());let packet={id:this._queueSeq++,tryCount:0,pending:!1,args,flags:Object.assign({fromQueue:!0},this.flags)};args.push((err,...responseArgs)=>packet!==this._queue[0]?void 0:(err!==null?packet.tryCount>this._opts.retries&&(this._queue.shift(),ack&&ack(err)):(this._queue.shift(),ack&&ack(null,...responseArgs)),packet.pending=!1,this._drainQueue())),this._queue.push(packet),this._drainQueue()}_drainQueue(force=!1){if(!this.connected||this._queue.length===0)return;let packet=this._queue[0];packet.pending&&!force||(packet.pending=!0,packet.tryCount++,this.flags=packet.flags,this.emit.apply(this,packet.args))}packet(packet){packet.nsp=this.nsp,this.io._packet(packet)}onopen(){typeof this.auth=="function"?this.auth(data=>{this._sendConnectPacket(data)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(data){this.packet({type:PacketType.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},data):data})}onerror(err){this.connected||this.emitReserved("connect_error",err)}onclose(reason,description){this.connected=!1,delete this.id,this.emitReserved("disconnect",reason,description)}onpacket(packet){if(packet.nsp===this.nsp)switch(packet.type){case PacketType.CONNECT:packet.data&&packet.data.sid?this.onconnect(packet.data.sid,packet.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case PacketType.EVENT:case PacketType.BINARY_EVENT:this.onevent(packet);break;case PacketType.ACK:case PacketType.BINARY_ACK:this.onack(packet);break;case PacketType.DISCONNECT:this.ondisconnect();break;case PacketType.CONNECT_ERROR:this.destroy();let err=new Error(packet.data.message);err.data=packet.data.data,this.emitReserved("connect_error",err);break}}onevent(packet){let args=packet.data||[];packet.id!=null&&args.push(this.ack(packet.id)),this.connected?this.emitEvent(args):this.receiveBuffer.push(Object.freeze(args))}emitEvent(args){if(this._anyListeners&&this._anyListeners.length){let listeners=this._anyListeners.slice();for(let listener of listeners)listener.apply(this,args)}super.emit.apply(this,args),this._pid&&args.length&&typeof args[args.length-1]=="string"&&(this._lastOffset=args[args.length-1])}ack(id){let self2=this,sent=!1;return function(...args){sent||(sent=!0,self2.packet({type:PacketType.ACK,id,data:args}))}}onack(packet){let ack=this.acks[packet.id];typeof ack=="function"&&(ack.apply(this,packet.data),delete this.acks[packet.id])}onconnect(id,pid){this.id=id,this.recovered=pid&&this._pid===pid,this._pid=pid,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(args=>this.emitEvent(args)),this.receiveBuffer=[],this.sendBuffer.forEach(packet=>{this.notifyOutgoingListeners(packet),this.packet(packet)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(subDestroy=>subDestroy()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:PacketType.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(compress){return this.flags.compress=compress,this}get volatile(){return this.flags.volatile=!0,this}timeout(timeout){return this.flags.timeout=timeout,this}onAny(listener){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(listener),this}prependAny(listener){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(listener),this}offAny(listener){if(!this._anyListeners)return this;if(listener){let listeners=this._anyListeners;for(let i2=0;i2<listeners.length;i2++)if(listener===listeners[i2])return listeners.splice(i2,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(listener){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(listener),this}prependAnyOutgoing(listener){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(listener),this}offAnyOutgoing(listener){if(!this._anyOutgoingListeners)return this;if(listener){let listeners=this._anyOutgoingListeners;for(let i2=0;i2<listeners.length;i2++)if(listener===listeners[i2])return listeners.splice(i2,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(packet){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){let listeners=this._anyOutgoingListeners.slice();for(let listener of listeners)listener.apply(this,packet.data)}}};function Backoff(opts){opts=opts||{},this.ms=opts.min||100,this.max=opts.max||1e4,this.factor=opts.factor||2,this.jitter=opts.jitter>0&&opts.jitter<=1?opts.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var ms=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var rand=Math.random(),deviation=Math.floor(rand*this.jitter*ms);ms=Math.floor(rand*10)&1?ms+deviation:ms-deviation}return Math.min(ms,this.max)|0};Backoff.prototype.reset=function(){this.attempts=0};Backoff.prototype.setMin=function(min){this.ms=min};Backoff.prototype.setMax=function(max){this.max=max};Backoff.prototype.setJitter=function(jitter){this.jitter=jitter};var Manager=class extends Emitter{constructor(uri,opts){var _a;super(),this.nsps={},this.subs=[],uri&&typeof uri=="object"&&(opts=uri,uri=void 0),opts=opts||{},opts.path=opts.path||"/socket.io",this.opts=opts,installTimerFunctions(this,opts),this.reconnection(opts.reconnection!==!1),this.reconnectionAttempts(opts.reconnectionAttempts||1/0),this.reconnectionDelay(opts.reconnectionDelay||1e3),this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3),this.randomizationFactor((_a=opts.randomizationFactor)!==null&&_a!==void 0?_a:.5),this.backoff=new Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(opts.timeout==null?2e4:opts.timeout),this._readyState="closed",this.uri=uri;let _parser=opts.parser||esm_exports;this.encoder=new _parser.Encoder,this.decoder=new _parser.Decoder,this._autoConnect=opts.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(v){return arguments.length?(this._reconnection=!!v,this):this._reconnection}reconnectionAttempts(v){return v===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=v,this)}reconnectionDelay(v){var _a;return v===void 0?this._reconnectionDelay:(this._reconnectionDelay=v,(_a=this.backoff)===null||_a===void 0||_a.setMin(v),this)}randomizationFactor(v){var _a;return v===void 0?this._randomizationFactor:(this._randomizationFactor=v,(_a=this.backoff)===null||_a===void 0||_a.setJitter(v),this)}reconnectionDelayMax(v){var _a;return v===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=v,(_a=this.backoff)===null||_a===void 0||_a.setMax(v),this)}timeout(v){return arguments.length?(this._timeout=v,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(fn){if(~this._readyState.indexOf("open"))return this;this.engine=new Socket(this.uri,this.opts);let socket=this.engine,self2=this;this._readyState="opening",this.skipReconnect=!1;let openSubDestroy=on(socket,"open",function(){self2.onopen(),fn&&fn()}),onError=err=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",err),fn?fn(err):this.maybeReconnectOnOpen()},errorSub=on(socket,"error",onError);if(this._timeout!==!1){let timeout=this._timeout,timer=this.setTimeoutFn(()=>{openSubDestroy(),onError(new Error("timeout")),socket.close()},timeout);this.opts.autoUnref&&timer.unref(),this.subs.push(()=>{this.clearTimeoutFn(timer)})}return this.subs.push(openSubDestroy),this.subs.push(errorSub),this}connect(fn){return this.open(fn)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");let socket=this.engine;this.subs.push(on(socket,"ping",this.onping.bind(this)),on(socket,"data",this.ondata.bind(this)),on(socket,"error",this.onerror.bind(this)),on(socket,"close",this.onclose.bind(this)),on(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(data){try{this.decoder.add(data)}catch(e){this.onclose("parse error",e)}}ondecoded(packet){nextTick(()=>{this.emitReserved("packet",packet)},this.setTimeoutFn)}onerror(err){this.emitReserved("error",err)}socket(nsp,opts){let socket=this.nsps[nsp];return socket?this._autoConnect&&!socket.active&&socket.connect():(socket=new Socket2(this,nsp,opts),this.nsps[nsp]=socket),socket}_destroy(socket){let nsps=Object.keys(this.nsps);for(let nsp of nsps)if(this.nsps[nsp].active)return;this._close()}_packet(packet){let encodedPackets=this.encoder.encode(packet);for(let i2=0;i2<encodedPackets.length;i2++)this.engine.write(encodedPackets[i2],packet.options)}cleanup(){this.subs.forEach(subDestroy=>subDestroy()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(reason,description){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",reason,description),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;let self2=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{let delay=this.backoff.duration();this._reconnecting=!0;let timer=this.setTimeoutFn(()=>{self2.skipReconnect||(this.emitReserved("reconnect_attempt",self2.backoff.attempts),!self2.skipReconnect&&self2.open(err=>{err?(self2._reconnecting=!1,self2.reconnect(),this.emitReserved("reconnect_error",err)):self2.onreconnect()}))},delay);this.opts.autoUnref&&timer.unref(),this.subs.push(()=>{this.clearTimeoutFn(timer)})}}onreconnect(){let attempt=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",attempt)}};var cache={};function lookup2(uri,opts){typeof uri=="object"&&(opts=uri,uri=void 0),opts=opts||{};let parsed=url(uri,opts.path||"/socket.io"),source=parsed.source,id=parsed.id,path2=parsed.path,sameNamespace=cache[id]&&path2 in cache[id].nsps,newConnection=opts.forceNew||opts["force new connection"]||opts.multiplex===!1||sameNamespace,io;return newConnection?io=new Manager(source,opts):(cache[id]||(cache[id]=new Manager(source,opts)),io=cache[id]),parsed.query&&!opts.query&&(opts.query=parsed.queryKey),io.socket(parsed.path,opts)}Object.assign(lookup2,{Manager,Socket:Socket2,io:lookup2,connect:lookup2});var import_path=__toESM(require("path"));function secondToTime(second){if(second=second||0,second===0||second===1/0||second.toString()==="NaN")return"00:00";let add0=num=>num<10?"0"+num:""+num,hour=Math.floor(second/3600),min=Math.floor((second-hour*3600)/60),sec=Math.floor(second-hour*3600-min*60);return(hour>0?[hour,min,sec]:[min,sec]).map(add0).join(":")}function _insertToView(s,view){let{editor}=view,cursor=editor.getCursor("from");editor.replaceRange(s,cursor,cursor);let setCur=Object.assign({},cursor);setCur.ch=setCur.ch+s.length,editor.setCursor(setCur)}var insertTimeStampToMDView=(pos,view)=>{let _str=`> ${secondToTime(pos)}`;_insertToView(_str,view)},insertVideoToMDView=(videoInfo2,view)=>{if(!videoInfo2)return;let{vname,vpath}=videoInfo2;vpath=vpath.replaceAll("\\","/");let _str=`[${vname}](${vpath}&ziyu)`;_insertToView(_str,view)},insertImgToMDView=(imgName,view)=>{let _str="";if(imgName.startsWith("http"))_str=`![](${imgName})`;else{let{base}=import_path.default.parse(imgName);_str=`![[${base}]]`}_insertToView(_str,view)},insertSubtitleToMDView=(subtitle,view)=>{_insertToView(subtitle,view)},insertAllSubtitleToMDView=(subtitles,view)=>{_insertToView(subtitles,view)};var import_obsidian=require("obsidian"),socketForZiyu=null,mdView;function localVideo(){listenOn("25588")}function netVideo(){listenOn("25565")}function mpvVideo(){listenOn("25588")}function listenOn(port){socketForZiyu&&(socketForZiyu.close(),socketForZiyu=null),socketForZiyu=lookup2(`http://127.0.0.1:${port}`),socketForZiyu.on("connect",()=>{new import_obsidian.Notice("\u8FDE\u63A5\u6210\u529F")}),socketForZiyu.on("disconnect",reason=>{socketForZiyu&&(socketForZiyu.close(),socketForZiyu=null,new import_obsidian.Notice("\u65AD\u5F00\u8FDE\u63A5"))}),socketForZiyu.on("plugin-answer-insert-time",data=>{insertTimeStampToMDView(data,mdView)}),socketForZiyu.on("plugin-answer-subtitle",data=>{insertSubtitleToMDView(data,mdView)}),socketForZiyu.on("plugin-answer-ocr",data=>{insertSubtitleToMDView(data,mdView)}),socketForZiyu.on("plugin-answer-all-subtitle",data=>{insertAllSubtitleToMDView(data,mdView)}),socketForZiyu.on("plugin-answer-screenshot",data=>{data&&insertImgToMDView(data,mdView)}),socketForZiyu.on("plugin-answer-videoinfo",data=>{data&&insertVideoToMDView(data,mdView)})}function insertTime(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-insert-time","")}function ocrScreen(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-ocr","")}function insertSubtitle(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-subtitle","")}function insertAllSubtitle(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-all-subtitle","")}function screenshot(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-screenshot","")}function screenshotEdit(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-screenshot-e","")}function videoInfo(view){mdView=view,socketForZiyu&&socketForZiyu.emit("plugin-back-videoinfo","")}function openVideo2(url2){url2&&socketForZiyu&&socketForZiyu.emit("plugin-back-openvideo",url2)}function seekVideo(timeStr){socketForZiyu&&socketForZiyu.emit("plugin-back-seek",timeStr)}function togglePlay(){socketForZiyu&&socketForZiyu.emit("plugin-back-toggleplay","")}function playMove(){socketForZiyu&&socketForZiyu.emit("plugin-back-play-move","")}function playBack(){socketForZiyu&&socketForZiyu.emit("plugin-back-play-back","")}function closeConnect(){socketForZiyu&&(socketForZiyu.close(),socketForZiyu=null,new import_obsidian.Notice("\u65AD\u5F00\u8FDE\u63A5"))}var import_obsidian2=require("obsidian"),getVideoUrls=md=>{let urls=[],res=md.match(/\[.*?\]\(.*?\)/g);if(res){let ziyu=res.filter(e=>e.includes("&ziyu"));if(ziyu.length>0)for(let i2=0;i2<ziyu.length;i2++){let arr=ziyu[i2].split("("),url2=arr[1].replace("&ziyu)",""),name=arr[0].replace("[","").replace("]","").replace("(","");urls.push({url:url2,name})}}return urls},VideoUrlsModal=class extends import_obsidian2.Modal{constructor(app,urls,onSubmit){super(app);this.onSubmit=onSubmit,this.urls=urls}onOpen(){let{contentEl}=this;contentEl.createEl("h1",{text:"\u8BF7\u9009\u62E9\u8981\u6253\u5F00\u7684\u89C6\u9891"});for(let i2=0;i2<this.urls.length;i2++)new import_obsidian2.Setting(contentEl).setName(this.urls[i2].name),new import_obsidian2.Setting(contentEl).addButton(btn=>btn.setButtonText("\u6253\u5F00").setCta().onClick(()=>{this.close(),this.onSubmit(this.urls[i2].url)}))}onClose(){let{contentEl}=this;contentEl.empty()}};var ZiyuNotePlugin=class extends import_obsidian3.Plugin{async onload(){await this.loadSettings(),(0,import_obsidian3.addIcon)("ziyunote",ziyunoteIcon),this.addRibbonIcon("ziyunote","\u5B50\u9B5A\u7B14\u8BB0",async event=>{let menu=new import_obsidian3.Menu;menu.addItem(item=>item.setTitle("\u672C\u5730\u89C6\u9891\u7B14\u8BB0").setIcon("pencil").onClick(()=>{localVideo()})),menu.addItem(item=>item.setTitle("mpv\u89C6\u9891\u7B14\u8BB0").setIcon("film").onClick(()=>{mpvVideo()})),menu.addItem(item=>item.setTitle("\u5728\u7EBF\u89C6\u9891\u7B14\u8BB0").setIcon("tv-2").onClick(()=>{netVideo()})),menu.addItem(item=>item.setTitle("\u65AD\u5F00\u8FDE\u63A5").setIcon("unlink-2").onClick(()=>{closeConnect()})),menu.addItem(item=>item.setTitle("\u6253\u5F00\u5B50\u9B5A\u7B14\u8BB0").setIcon("laptop").onClick(()=>{window.open("ziyunote:?open=net")})),menu.showAtMouseEvent(event)}),this.addSettingTab(new ZiyuNoteSettingTab(this.app,this)),this.addAllCommand(),this.registerDomEvent(document,"click",async evt=>{let dom=evt.target,{nodeName,className}=dom;if(nodeName=="SPAN"){let txt=dom.innerText;if(className.includes("quote ")){let re2=txt.match(/\d+:\d+:*\d*/g);if(!re2)return!1;let timeStr=re2[0];(timeStr.length==5||timeStr.length==8)&&seekVideo(timeStr)}}})}addAllCommand(){this.addCommand({id:"ziyunote-insert-time",name:"\u63D2\u5165\u65F6\u95F4\u6233",editorCallback:async(editor,view)=>{insertTime(view)}}),this.addCommand({id:"ziyunote-screenshot",name:"\u622A\u56FE",editorCallback:async(editor,view)=>{screenshot(view)}}),this.addCommand({id:"ziyunote-screenshot-e",name:"\u622A\u56FE-\u7F16\u8F91",editorCallback:async(editor,view)=>{screenshotEdit(view)}}),this.addCommand({id:"ziyunote-insert-videoinfo",name:"\u63D2\u5165\u89C6\u9891\u4FE1\u606F",editorCallback:async(editor,view)=>{videoInfo(view)}}),this.addCommand({id:"open-ziyunote-video",name:"\u6253\u5F00\u89C6\u9891",editorCallback:(editor,view)=>{let urls=getVideoUrls(view.getViewData());if(urls.length==1)openVideo2(urls[0].url);else if(urls.length>1){let onSubmit=async url2=>{openVideo2(url2)};new VideoUrlsModal(this.app,urls,onSubmit).open()}}}),this.addCommand({id:"ziyunote-insert-subtitle",name:"\u63D2\u5165\u5B57\u5E55\uFF08\u4E0D\u652F\u6301\u5728\u7EBF\u89C6\u9891\uFF09",editorCallback:async(editor,view)=>{insertSubtitle(view)}}),this.addCommand({id:"ziyunote-insert-all-subtitle",name:"\u5BFC\u5165\u6574\u4E2A\u5B57\u5E55\u5230\u7B14\u8BB0\u4E2D",editorCallback:async(editor,view)=>{insertAllSubtitle(view)}}),this.addCommand({id:"ziyunote-ocr",name:"OCR \u8BC6\u522B\u5F53\u524D\u56FE\u7247",editorCallback:async(editor,view)=>{ocrScreen(view)}}),this.addCommand({id:"ziyunote-toggleplay",name:"\u6682\u505C/\u64AD\u653E\u89C6\u9891",editorCallback:async(editor,view)=>{togglePlay()}}),this.addCommand({id:"ziyunote-play-move",name:"\u5FEB\u8FDB\u89C6\u9891",editorCallback:async(editor,view)=>{playMove()}}),this.addCommand({id:"ziyunote-play-back",name:"\u5FEB\u9000\u89C6\u9891",editorCallback:async(editor,view)=>{playBack()}})}onunload(){}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},ZiyuNoteSettingTab=class extends import_obsidian3.PluginSettingTab{constructor(app,plugin){super(app,plugin);this.plugin=plugin}display(){let{containerEl}=this;containerEl.empty(),containerEl.createEl("h2",{text:"\u5B98\u7F51\uFF08http://vnote.littlefly.fun/\uFF09"})}};
